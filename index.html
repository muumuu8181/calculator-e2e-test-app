
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculator App v0.1</title>
    
    <!-- iPhone„Éõ„Éº„É†ÁîªÈù¢Áî®„ÅÆË®≠ÂÆö -->
    <link rel="apple-touch-icon" href="icon-180.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Calculator App">
    
    <!-- Android/„Åù„ÅÆ‰ªñÁî® -->
    <link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
    <link rel="manifest" href="manifest.json">
    
    <!-- „Ç´„Çπ„Çø„É†„Çπ„Çø„Ç§„É´ -->
    <link rel="stylesheet" href="src/custom/styles.css">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    
    <!-- „Ç´„Çπ„Çø„É†Ë®≠ÂÆö -->
    <script type="module" src="src/custom/app-config.js"></script>
    <style>
        body { font-family: Arial, sans-serif; padding: 5px; background: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 10px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        
        /* „Éë„Éç„É´Ë°®Á§∫„É¢„Éº„ÉâÂàá„ÇäÊõø„Åà */
        body.panel-mode .section-panel {
            position: relative;
            border: 3px solid #007bff;
            border-radius: 8px;
            padding: 20px;
            margin: 15px 0;
            background: white;
            box-shadow: 0 2px 5px rgba(0,123,255,0.2);
        }
        body.panel-mode .panel-number {
            display: block;
            position: absolute;
            top: -15px;
            left: 15px;
            background: #007bff;
            color: white;
            padding: 2px 10px;
            font-weight: bold;
            font-size: 16px;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            z-index: 10;
        }
        
        /* ÈÄöÂ∏∏„É¢„Éº„Éâ */
        body:not(.panel-mode) .section-panel {
            position: relative;
            padding: 10px;
            margin: 10px 0;
        }
        body:not(.panel-mode) .panel-number {
            display: none;
        }
        
        /* ÈöéÂ±§„Çµ„Ç§„Ç∫ */
        .panel-L { /* Â§ß */ }
        .panel-M { /* ‰∏≠ */
            padding: 15px !important;
            border-width: 2px !important;
        }
        .panel-S { /* Â∞è */
            padding: 10px !important;
            border-width: 1px !important;
            margin: 5px 0 !important;
        }
        
        /* „É¢„Éº„ÉâÂàá„ÇäÊõø„Åà„Éú„Çø„É≥ */
        .mode-toggle {
            position: fixed;
            top: 10px;
            right: 10px;
            background: #007bff;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            z-index: 1000;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .mode-toggle:hover {
            background: #0056b3;
        }
        .grid-toggle {
            position: fixed;
            top: 50px;
            right: 10px;
            background: #28a745;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            z-index: 10000001;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .grid-toggle:hover {
            background: #218838;
        }
        
        /* „Ç∞„É™„ÉÉ„ÉâË°®Á§∫„É¢„Éº„ÉâÔºà„Ç∑„É≥„Éó„É´ÁâàÔºâ */
        body.grid-mode::before {
            content: "üìê „Ç∞„É™„ÉÉ„ÉâË°®Á§∫„É¢„Éº„Éâ";
            position: fixed;
            top: 50px;
            right: 10px;
            background: rgba(255,255,255,0.95);
            padding: 5px 10px;
            border-radius: 5px;
            font-weight: bold;
            z-index: 1000001;
        }
        
        /* „Çπ„Éû„ÉõÂØæÂøú */
        @media (max-width: 768px) {
            body { padding: 3px; }
            .container { padding: 8px; margin: 0; border-radius: 0; }
            .weight-input { grid-template-columns: 1fr; gap: 8px; }
            .input-card { padding: 8px; }
        }
        .auth-section { background: #e7f3ff; color: #0c5460; padding: 10px; border-radius: 5px; text-align: center; }
        .weight-input { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 10px; margin: 8px 0; }
        .input-card { border: 1px solid #ddd; padding: 8px; border-radius: 8px; }
        
        /* „Çø„Ç§„Éü„É≥„Ç∞„Éë„Éç„É´„ÅÆ„Çπ„Çø„Ç§„É´ */
        .timing-panel { 
            background: #f8f9fa; 
            border: 2px solid #e9ecef; 
            border-radius: 8px; 
            padding: 8px; 
            margin: 5px 0; 
        }
        .timing-buttons { 
            display: flex; 
            gap: 4px; 
            flex-wrap: wrap; 
            justify-content: center;
        }
        .timing-btn, .tool-btn { 
            background: #6c757d; 
            color: white; 
            border: none; 
            padding: 6px 8px; 
            border-radius: 12px; 
            cursor: pointer; 
            font-size: 11px;
            transition: all 0.2s;
            min-width: 70px;
            text-align: center;
            margin: 2px;
        }
        .timing-btn:hover, .tool-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 0 15px rgba(255, 255, 255, 0.5);
        }
        .timing-btn.selected, .tool-btn.active {
            transform: scale(1.1);
            box-shadow: 0 0 20px rgba(255, 0, 128, 0.8);
            border: 2px solid #fff;
        }
        .brush-tools {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
            justify-content: center;
            margin: 10px 0;
        }
        #paintCanvas {
            box-shadow: 0 0 30px rgba(255, 0, 128, 0.3);
        }
        
        @media (max-width: 768px) {
            .timing-buttons { gap: 3px; }
            .timing-btn { 
                padding: 4px 6px; 
                font-size: 10px;
                min-width: 60px;
            }
        }
        .input-field { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; margin: 5px 0; font-size: 16px; }
        .save-button { background: #28a745; color: white; border: none; padding: 12px 24px; border-radius: 5px; cursor: pointer; margin: 5px; font-size: 16px; }
        .save-button:hover { background: #218838; }
        .auth-button { background: #4285f4; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin: 5px; }
        .auth-button:hover { background: #357ae8; }
        .logout-button { background: #dc3545; color: white; border: none; padding: 8px 16px; border-radius: 5px; cursor: pointer; margin: 5px; }
        .data-area { background: #f8f9fa; border: 1px solid #dee2e6; padding: 8px; border-radius: 5px; font-family: monospace; min-height: 120px; }
        .hidden { display: none; }
        .user-info { background: #d4edda; color: #155724; padding: 6px; border-radius: 5px; margin-bottom: 8px; }
    </style>
</head>
<body class="panel-mode">
    <!-- ‚ö†Ô∏è ÈñãÁô∫Ë£úÂä©Ê©üËÉΩÔºàÂâäÈô§Á¶ÅÊ≠¢Ôºâ -->
    <button class="mode-toggle" onclick="togglePanelMode()">üìä „Éë„Éç„É´Ë°®Á§∫</button>
    <button class="grid-toggle" onclick="toggleGridMode()">‚äû „Ç∞„É™„ÉÉ„ÉâË°®Á§∫</button>
    <!-- ÈñãÁô∫Ë£úÂä©Ê©üËÉΩ„Åì„Åì„Åæ„Åß -->
    
    <div class="container">
        <!-- ‚ö†Ô∏è „Éë„Éç„É´1: Ë™çË®ºÔºàÂâäÈô§Á¶ÅÊ≠¢Ôºâ -->
        <div class="section-panel panel-L">
            <span class="panel-number">[1-L]</span>
            <div class="app-header">
                <h1 class="app-title">üßÆ Calculator App v0.1</h1>
                <p class="app-subtitle">„Ç∑„É≥„Éó„É´„Å™ÈõªÂçì„Ç¢„Éó„É™„Ç±„Éº„Ç∑„Éß„É≥</p>
            </div>
            <!-- Ë™çË®º„Çª„ÇØ„Ç∑„Éß„É≥ -->
            <div class="auth-section" id="authSection">
                <h3>üîê „É≠„Ç∞„Ç§„É≥</h3>
                <p>Google„Ç¢„Ç´„Ç¶„É≥„Éà„Åß„É≠„Ç∞„Ç§„É≥„Åó„Å¶„Éá„Éº„Çø„Çí‰øùÂ≠ò„ÉªÂêåÊúü„Åß„Åç„Åæ„Åô</p>
                <button class="auth-button" onclick="handleGoogleLogin()">Google„Åß„É≠„Ç∞„Ç§„É≥</button>
            </div>
            <!-- „É¶„Éº„Ç∂„ÉºÊÉÖÂ†±Ë°®Á§∫ („É≠„Ç∞„Ç§„É≥Âæå„Å´Ë°®Á§∫) -->
            <div class="user-info section-panel panel-M hidden" id="userInfo">
                <span class="panel-number">[1.1-M]</span>
                <span>üë§ „É≠„Ç∞„Ç§„É≥‰∏≠: <span id="userName"></span></span>
                <button class="logout-button" onclick="handleLogout()">„É≠„Ç∞„Ç¢„Ç¶„Éà</button>
            </div>
        </div>
        
        <!-- „Éë„Éç„É´2: ÈõªÂçìÔºà„Ç´„Çπ„Çø„Éû„Ç§„Ç∫È†òÂüüÔºâ -->
        <div class="section-panel panel-L hidden" id="userPanel">
            <span class="panel-number">[2-L]</span>

            <!-- ÈõªÂçì -->
            <div class="calculator-tools" id="calculatorTools">
                <div class="calculator-panel section-panel panel-M" data-grid="B3">
                    <span class="panel-number">[2.1-M]</span>
                    <h3 style="margin-top: 0; margin-bottom: 8px;">üßÆ Calculator</h3>
                    
                    <!-- „Éá„Ç£„Çπ„Éó„É¨„Ç§ -->
                    <div class="calculator-display" style="margin-bottom: 15px;">
                        <input type="text" id="display" readonly 
                               style="width: 100%; padding: 15px; font-size: 24px; text-align: right; 
                                      border: 2px solid #007bff; border-radius: 8px; background: #f8f9fa;">
                    </div>
                    
                    <!-- „Éú„Çø„É≥ -->
                    <div class="calculator-buttons" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px;">
                        <button onclick="clearDisplay()" data-testid="clear-btn" 
                                style="background: #dc3545; color: white; border: none; padding: 15px; border-radius: 5px; font-size: 18px; cursor: pointer;">C</button>
                        <button onclick="appendToDisplay('/')" data-testid="divide-btn"
                                style="background: #28a745; color: white; border: none; padding: 15px; border-radius: 5px; font-size: 18px; cursor: pointer;">√∑</button>
                        <button onclick="appendToDisplay('*')" data-testid="multiply-btn"
                                style="background: #28a745; color: white; border: none; padding: 15px; border-radius: 5px; font-size: 18px; cursor: pointer;">√ó</button>
                        <button onclick="deleteLast()" data-testid="delete-btn"
                                style="background: #ffc107; color: black; border: none; padding: 15px; border-radius: 5px; font-size: 18px; cursor: pointer;">‚å´</button>
                        
                        <button onclick="appendToDisplay('7')" data-testid="number-7"
                                style="background: #6c757d; color: white; border: none; padding: 15px; border-radius: 5px; font-size: 18px; cursor: pointer;">7</button>
                        <button onclick="appendToDisplay('8')" data-testid="number-8"
                                style="background: #6c757d; color: white; border: none; padding: 15px; border-radius: 5px; font-size: 18px; cursor: pointer;">8</button>
                        <button onclick="appendToDisplay('9')" data-testid="number-9"
                                style="background: #6c757d; color: white; border: none; padding: 15px; border-radius: 5px; font-size: 18px; cursor: pointer;">9</button>
                        <button onclick="appendToDisplay('-')" data-testid="subtract-btn"
                                style="background: #28a745; color: white; border: none; padding: 15px; border-radius: 5px; font-size: 18px; cursor: pointer;">-</button>
                        
                        <button onclick="appendToDisplay('4')" data-testid="number-4"
                                style="background: #6c757d; color: white; border: none; padding: 15px; border-radius: 5px; font-size: 18px; cursor: pointer;">4</button>
                        <button onclick="appendToDisplay('5')" data-testid="number-5"
                                style="background: #6c757d; color: white; border: none; padding: 15px; border-radius: 5px; font-size: 18px; cursor: pointer;">5</button>
                        <button onclick="appendToDisplay('6')" data-testid="number-6"
                                style="background: #6c757d; color: white; border: none; padding: 15px; border-radius: 5px; font-size: 18px; cursor: pointer;">6</button>
                        <button onclick="appendToDisplay('+')" data-testid="add-btn"
                                style="background: #28a745; color: white; border: none; padding: 15px; border-radius: 5px; font-size: 18px; cursor: pointer;">+</button>
                        
                        <button onclick="appendToDisplay('1')" data-testid="number-1"
                                style="background: #6c757d; color: white; border: none; padding: 15px; border-radius: 5px; font-size: 18px; cursor: pointer;">1</button>
                        <button onclick="appendToDisplay('2')" data-testid="number-2"
                                style="background: #6c757d; color: white; border: none; padding: 15px; border-radius: 5px; font-size: 18px; cursor: pointer;">2</button>
                        <button onclick="appendToDisplay('3')" data-testid="number-3"
                                style="background: #6c757d; color: white; border: none; padding: 15px; border-radius: 5px; font-size: 18px; cursor: pointer;">3</button>
                        <button onclick="calculate()" data-testid="equals-btn" 
                                style="background: #007bff; color: white; border: none; padding: 15px; border-radius: 5px; font-size: 18px; cursor: pointer; grid-row: span 2;">=</button>
                        
                        <button onclick="appendToDisplay('0')" data-testid="number-0"
                                style="background: #6c757d; color: white; border: none; padding: 15px; border-radius: 5px; font-size: 18px; cursor: pointer; grid-column: span 2;">0</button>
                        <button onclick="appendToDisplay('.')" data-testid="decimal-btn"
                                style="background: #6c757d; color: white; border: none; padding: 15px; border-radius: 5px; font-size: 18px; cursor: pointer;">.</button>
                    </div>
                    
                    <!-- ‰øùÂ≠ò„Éú„Çø„É≥ -->
                    <div style="text-align: center; margin-top: 15px;">
                        <button onclick="saveCalculation()" data-testid="save-btn"
                                style="background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 5px; margin: 5px;">üßÆ Ë®àÁÆó‰øùÂ≠ò</button>
                        <input type="text" id="calculationNote" placeholder="„É°„É¢" data-testid="note-input"
                               style="margin: 5px; padding: 8px; border-radius: 5px; border: 1px solid #007bff;">
                    </div>
                </div>
            </div>
        </div>

        <!-- ‚ö†Ô∏è „Éë„Éç„É´3: „É≠„Ç∞ÔºàÂâäÈô§Á¶ÅÊ≠¢Ôºâ -->
        <div class="section-panel panel-L">
            <span class="panel-number">[3-L]</span>
            <h3>üìã „Ç¢„Éó„É™„É≠„Ç∞ <button class="universal-copy-btn" onclick="copyLogs()" style="background: #28a745; color: white; border: none; padding: 4px 8px; border-radius: 3px; cursor: pointer; font-size: 12px;">üìã „É≠„Ç∞„Çí„Ç≥„Éî„Éº</button></h3>
            <div class="data-area" id="logArea">
            „Ç¢„Éó„É™„ÉÜ„É≥„Éó„É¨„Éº„Éà v0.37 Ëµ∑ÂãïÂÆå‰∫Ü...<br>
            üî• FirebaseË®≠ÂÆöÂÆå‰∫Ü<br>
            üîê GoogleË™çË®ºÊ∫ñÂÇôÂÆå‰∫Ü<br>
            </div>
        </div>
        
        <!-- ‚ö†Ô∏è „Éë„Éç„É´4: „Éá„Éê„ÉÉ„Ç∞„Éú„Çø„É≥ÔºàÂâäÈô§Á¶ÅÊ≠¢Ôºâ -->
        <div class="section-panel panel-L" style="margin-top: 8px; text-align: center;">
            <span class="panel-number">[4-L]</span>
            <button class="universal-copy-btn" onclick="debugFirebaseConnection()" style="background: #ff6b6b; color: white; border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer; margin: 5px;">üîç Firebase Debug</button>
            <button onclick="testGridAdjust()" style="background: #17a2b8; color: white; border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer; margin: 5px;">üìê GridË™øÊï¥„ÉÜ„Çπ„Éà</button>
            <button class="universal-copy-btn" onclick="checkLoginIssues()" style="background: #ffc107; color: #212529; border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer; margin: 5px;">‚ö†Ô∏è „É≠„Ç∞„Ç§„É≥ÂïèÈ°åË®∫Êñ≠</button>
            <button class="universal-copy-btn" onclick="copyDebugInfo()" style="background: #17a2b8; color: white; border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer; margin: 5px;">üìã „Éá„Éê„ÉÉ„Ç∞ÊÉÖÂ†±„Çí„Ç≥„Éî„Éº</button>
            <button class="universal-copy-btn" onclick="checkDatabaseStructure()" style="background: #6f42c1; color: white; border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer; margin: 5px;">üèóÔ∏è DBÊßãÈÄ†Á¢∫Ë™ç</button>
            <button class="universal-copy-btn" onclick="checkMobileSupport()" style="background: #28a745; color: white; border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer; margin: 5px;">üì± „É¢„Éê„Ç§„É´Ë®∫Êñ≠</button>
            <button class="universal-copy-btn" onclick="forceAuthCheck()" style="background: #fd7e14; color: white; border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer; margin: 5px;">üîÑ Ë™çË®ºÁä∂ÊÖãÁ¢∫Ë™ç</button>
            <button class="universal-copy-btn" onclick="checkFirebaseConfig()" style="background: #dc3545; color: white; border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer; margin: 5px;">üîß FirebaseË®≠ÂÆö</button>
            <button class="universal-copy-btn" onclick="testPopup()" style="background: #20c997; color: white; border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer; margin: 5px;">üß™ „Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó„ÉÜ„Çπ„Éà</button>
            <button class="universal-copy-btn" onclick="window.open('test-error.html', '_blank')" style="background: #e74c3c; color: white; border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer; margin: 5px;">üö® „Ç®„É©„Éº„ÉÜ„Çπ„Éà</button>
        </div>
        
    </div>

    <script>
        // Core FirebaseË®≠ÂÆöÔºàÂ§âÊõ¥Á¶ÅÊ≠¢ - core/src/firebase-config.jsÂèÇÁÖßÔºâ
        const firebaseConfig = {
            apiKey: "AIzaSyA5PXKChizYDCXF_GJ4KL6Ylq9K5hCPXWE",
            authDomain: "shares-b1b97.firebaseapp.com",
            databaseURL: "https://shares-b1b97-default-rtdb.firebaseio.com",
            projectId: "shares-b1b97",
            storageBucket: "shares-b1b97.firebasestorage.app",
            messagingSenderId: "38311063248",
            appId: "1:38311063248:web:0d2d5726d12b305b24b8d5"
        };

        // FirebaseÂàùÊúüÂåñ
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();

        let currentUser = null;
        let selectedTimingValue = '';

        // „Ç≠„Éº„Éú„Éº„Éâ„Åß„ÅÆÂÄ§Ë™øÊï¥Ê©üËÉΩ
        window.handleWeightKeypress = (event) => {
            const weightInput = document.getElementById('weightValue');
            const currentValue = parseFloat(weightInput.value) || 50.0;
            
            if (event.key === 'ArrowUp') {
                event.preventDefault();
                weightInput.value = (currentValue + 0.1).toFixed(1);
            } else if (event.key === 'ArrowDown') {
                event.preventDefault();
                weightInput.value = Math.max(0, currentValue - 0.1).toFixed(1);
            }
        };

        // „Çø„Ç§„Éü„É≥„Ç∞ÈÅ∏ÊäûÊ©üËÉΩÔºàÊîπËâØÁâàÔºâ
        window.selectTiming = (timing) => {
            selectedTimingValue = timing;
            document.getElementById('selectedTiming').value = timing;
            
            // „Åô„Åπ„Å¶„ÅÆ„Éú„Çø„É≥„Åã„ÇâÈÅ∏ÊäûÁä∂ÊÖã„ÇíÂâäÈô§
            document.querySelectorAll('.timing-btn').forEach(btn => {
                btn.classList.remove('selected');
                btn.style.opacity = '0.7';
            });
            
            // ÈÅ∏Êäû„Åï„Çå„Åü„Éú„Çø„É≥„Å´ÈÅ∏ÊäûÁä∂ÊÖã„ÇíËøΩÂä†
            const selectedBtn = document.querySelector(`[data-timing="${timing}"]`);
            if (selectedBtn) {
                selectedBtn.classList.add('selected');
                selectedBtn.style.opacity = '1';
            }
            
            log(`‚è∞ Ê∏¨ÂÆö„Çø„Ç§„Éü„É≥„Ç∞ÈÅ∏Êäû: ${timing}`);
        };

        // Ë™çË®ºÁä∂ÊÖã„ÅÆÁõ£Ë¶ñÔºàÊîπËâØÁâàÔºâ
        auth.onAuthStateChanged((user) => {
            currentUser = user;
            if (user) {
                log(`‚úÖ Ë™çË®ºÁä∂ÊÖãÁ¢∫Ë™ç: ${user.displayName} „Åß„É≠„Ç∞„Ç§„É≥‰∏≠`);
                log(`üìß „É°„Éº„É´: ${user.email}`);
                showUserInterface(user);
                loadUserWeightData(user.uid);
            } else {
                log('üîí Ë™çË®ºÁä∂ÊÖã: Êú™„É≠„Ç∞„Ç§„É≥');
                showLoginInterface();
            }
        });

        // ÂàùÊúüÂåñÂÆå‰∫Ü„É≠„Ç∞
        log('üîÑ FirebaseË™çË®º„Ç∑„Çπ„ÉÜ„É†ÂàùÊúüÂåñÂÆå‰∫Ü - Ë™çË®ºÁä∂ÊÖã„ÇíÁ¢∫Ë™ç‰∏≠...');

        // Google„É≠„Ç∞„Ç§„É≥ÔºàÊîπËâØÁâà - „Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó„Éñ„É≠„ÉÉ„ÇØÊ§úÁü•‰ªò„ÅçÔºâ
        window.handleGoogleLogin = async () => {
            try {
                log('üîê Google„É≠„Ç∞„Ç§„É≥ÈñãÂßã...');
                const provider = new firebase.auth.GoogleAuthProvider();
                
                // „É¢„Éê„Ç§„É´„Éá„Éê„Ç§„ÇπÊ§úÂá∫ÔºàË°®Á§∫Áî®Ôºâ
                const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
                
                if (isMobile) {
                    log('üì± „É¢„Éê„Ç§„É´„Éá„Éê„Ç§„ÇπÊ§úÂá∫ - „Éù„ÉÉ„Éó„Ç¢„ÉÉ„ÉóÊñπÂºè„Åß„É≠„Ç∞„Ç§„É≥');
                    log('üí° „Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó„ÅåÈÄî‰∏≠„ÅßÊ≠¢„Åæ„ÇãÂ†¥Âêà„ÅØ„ÄÅ„Éñ„É©„Ç¶„Ç∂Ë®≠ÂÆö„ÅÆÁ¢∫Ë™ç„ÅåÂøÖË¶Å„Åß„Åô');
                } else {
                    log('üñ•Ô∏è „Éá„Çπ„ÇØ„Éà„ÉÉ„Éó„Éá„Éê„Ç§„Çπ - „Éù„ÉÉ„Éó„Ç¢„ÉÉ„ÉóÊñπÂºè„Åß„É≠„Ç∞„Ç§„É≥');
                }
                
                // „Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó„Éñ„É≠„ÉÉ„ÇØÊ§úÁü•„ÅÆ„Åü„ÇÅ„ÅÆ„Çø„Ç§„É†„Ç¢„Ç¶„ÉàË®≠ÂÆö
                log('ü™ü „Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó„Ç¶„Ç£„É≥„Éâ„Ç¶„ÅßGoogle„É≠„Ç∞„Ç§„É≥„ÇíÈñãÂßã...');
                
                const loginPromise = auth.signInWithPopup(provider);
                
                // „Çø„Ç§„É†„Ç¢„Ç¶„ÉàÊ§úÁü•Ôºà5Áßí„Åß„Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó„ÅåÈñã„Åã„Å™„ÅÑÂ†¥ÂêàÔºâ
                const timeoutPromise = new Promise((_, reject) => {
                    setTimeout(() => {
                        reject(new Error('„Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó„Çø„Ç§„É†„Ç¢„Ç¶„Éà - „Éñ„É≠„ÉÉ„ÇØ„Åï„Çå„ÅüÂèØËÉΩÊÄß„Åå„ÅÇ„Çä„Åæ„Åô'));
                    }, 5000);
                });
                
                try {
                    const result = await Promise.race([loginPromise, timeoutPromise]);
                    log(`‚úÖ „É≠„Ç∞„Ç§„É≥ÊàêÂäü: ${result.user.displayName}`);
                } catch (raceError) {
                    // „Çø„Ç§„É†„Ç¢„Ç¶„Éà„ÅÆÂ†¥Âêà„ÅÆÁâπÂà•Âá¶ÁêÜ
                    if (raceError.message.includes('„Çø„Ç§„É†„Ç¢„Ç¶„Éà')) {
                        log('‚è∞ „Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó„Åå5Áßí‰ª•ÂÜÖ„Å´Èñã„Åç„Åæ„Åõ„Çì„Åß„Åó„Åü');
                        log('üîÑ „Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó„Éñ„É≠„ÉÉ„ÇØÊ§úÁü• - Ëß£Ê±∫ÊñπÊ≥ï„Çí„ÅîÊ°àÂÜÖ„Åó„Åæ„Åô');
                        throw new Error('POPUP_TIMEOUT');
                    } else {
                        throw raceError;
                    }
                }
                
            } catch (error) {
                log(`‚ùå „É≠„Ç∞„Ç§„É≥„Ç®„É©„Éº: ${error.message}`);
                
                // „Ç®„É©„Éº„ÅÆË©≥Á¥∞ÊÉÖÂ†±„Çí„É≠„Ç∞„Å´Âá∫Âäõ
                if (error.code) {
                    log(`- „Ç®„É©„Éº„Ç≥„Éº„Éâ: ${error.code}`);
                    
                    // ÁâπÂÆö„ÅÆ„Ç®„É©„Éº„Ç≥„Éº„Éâ„Å´ÂØæ„Åô„ÇãËß£Ê±∫Á≠ñ„ÇíÊèêÁ§∫
                    switch(error.code) {
                        case 'auth/unauthorized-domain':
                            log('üí° „Éâ„É°„Ç§„É≥Ë®±ÂèØË®≠ÂÆö„ÅÆÂïèÈ°å„Åß„Åô');
                            log('üí° Firebase Console„ÅßË™çË®º„Éâ„É°„Ç§„É≥„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                            break;
                        case 'auth/popup-blocked':
                            log('üí° „Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó„Åå„Éñ„É≠„ÉÉ„ÇØ„Åï„Çå„Åæ„Åó„Åü');
                            showPopupGuide(isMobile);
                            break;
                        case 'auth/popup-closed-by-user':
                            log('üí° „É¶„Éº„Ç∂„Éº„Åå„Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó„ÇíÈñâ„Åò„Åæ„Åó„Åü');
                            log('üí° „ÇÇ„ÅÜ‰∏ÄÂ∫¶„É≠„Ç∞„Ç§„É≥„Éú„Çø„É≥„ÇíÊäº„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                            break;
                        case 'auth/cancelled-popup-request':
                            log('üí° ÂâçÂõû„ÅÆ„Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó„Åå„Ç≠„É£„É≥„Çª„É´„Åï„Çå„Åæ„Åó„Åü');
                            log('üí° „Åó„Å∞„Çâ„ÅèÂæÖ„Å£„Å¶„Åã„ÇâÂÜçË©¶Ë°å„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                            break;
                        default:
                            if (error.message === 'POPUP_TIMEOUT') {
                                log('‚ö†Ô∏è „Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó„ÅåÈÄî‰∏≠„ÅßÊ≠¢„Åæ„Çä„Åæ„Åó„Åü');
                                showPopupGuide(isMobile);
                            } else {
                                log('üí° „Éñ„É©„Ç¶„Ç∂„ÇíÊõ¥Êñ∞„Åó„Å¶„ÇÇ„ÅÜ‰∏ÄÂ∫¶„ÅäË©¶„Åó„Åè„Å†„Åï„ÅÑ');
                            }
                    }
                } else if (error.message === 'POPUP_TIMEOUT') {
                    showPopupGuide(isMobile);
                }
                
                if (error.credential) {
                    log('- Ë™çË®ºÊÉÖÂ†±„ÅØÂèñÂæóÊ∏à„Åø');
                }
            }
        };

        // „Éù„ÉÉ„Éó„Ç¢„ÉÉ„ÉóË®±ÂèØ„Ç¨„Ç§„ÉâË°®Á§∫
        function showPopupGuide(isMobile) {
            log('üìñ === „Éù„ÉÉ„Éó„Ç¢„ÉÉ„ÉóË®±ÂèØ„Ç¨„Ç§„Éâ ===');
            if (isMobile) {
                log('üì± „Çπ„Éû„Éº„Éà„Éï„Ç©„É≥Âêë„ÅëËß£Ê±∫ÊâãÈ†Ü:');
                log('1. „Éö„Éº„Ç∏‰∏äÈÉ®„ÅÆ„Ç¢„Éâ„É¨„Çπ„Éê„Éº„Å´Ë°®Á§∫„Åï„Çå„Çã„Äå„Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó„Åå„Éñ„É≠„ÉÉ„ÇØ„Åï„Çå„Åæ„Åó„Åü„Äç„Çí„Çø„ÉÉ„Éó');
                log('2. „Åæ„Åü„ÅØ„ÄÅ„Éñ„É©„Ç¶„Ç∂„É°„Éã„É•„Éº(‚ãÆ) ‚Üí Ë®≠ÂÆö ‚Üí „Çµ„Ç§„ÉàË®≠ÂÆö ‚Üí „Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó„Å®„É™„ÉÄ„Ç§„É¨„ÇØ„Éà ‚Üí Ë®±ÂèØ');
                log('3. Chrome: Âè≥‰∏ä‚ãÆ„É°„Éã„É•„Éº ‚Üí Ë®≠ÂÆö ‚Üí Ë©≥Á¥∞Ë®≠ÂÆö ‚Üí „Çµ„Ç§„ÉàË®≠ÂÆö ‚Üí „Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó„Å®„É™„ÉÄ„Ç§„É¨„ÇØ„Éà');
                log('4. Safari: Ë®≠ÂÆö„Ç¢„Éó„É™ ‚Üí Safari ‚Üí „Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó„Éñ„É≠„ÉÉ„ÇØ ‚Üí „Ç™„Éï');
                log('5. Ë®≠ÂÆöÂæå„ÄÅ„Åì„ÅÆ„Éö„Éº„Ç∏„ÇíÊõ¥Êñ∞„Åó„Å¶„ÇÇ„ÅÜ‰∏ÄÂ∫¶„É≠„Ç∞„Ç§„É≥„Éú„Çø„É≥„ÇíÊäº„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
            } else {
                log('üíª PCÂêë„ÅëËß£Ê±∫ÊâãÈ†Ü:');
                log('1. „Ç¢„Éâ„É¨„Çπ„Éê„ÉºÂè≥Á´Ø„ÅÆ„Ç¢„Ç§„Ç≥„É≥(üö´)„Çí„ÇØ„É™„ÉÉ„ÇØ ‚Üí Ë®±ÂèØ');
                log('2. „Åæ„Åü„ÅØ„ÄÅ„Éñ„É©„Ç¶„Ç∂Ë®≠ÂÆö ‚Üí „Éó„É©„Ç§„Éê„Ç∑„Éº„Å®„Çª„Ç≠„É•„É™„ÉÜ„Ç£ ‚Üí „Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó„Å®„É™„ÉÄ„Ç§„É¨„ÇØ„Éà ‚Üí Ë®±ÂèØ');
            }
            log('üí° „Åù„Çå„Åß„ÇÇËß£Ê±∫„Åó„Å™„ÅÑÂ†¥Âêà: „Éó„É©„Ç§„Éô„Éº„Éà„É¢„Éº„Éâ„ÇíÁµÇ‰∫Ü„Åô„Çã„Åã„ÄÅÂà•„ÅÆ„Éñ„É©„Ç¶„Ç∂„Çí„ÅäË©¶„Åó„Åè„Å†„Åï„ÅÑ');
            log('üîÑ „Éù„ÉÉ„Éó„Ç¢„ÉÉ„ÉóË®≠ÂÆö„ÇíÁ¢∫Ë™ç„Åó„Åü„Çâ„ÄÅÂÜçÂ∫¶„ÄåGoogle„Åß„É≠„Ç∞„Ç§„É≥„Äç„Éú„Çø„É≥„ÇíÊäº„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
            log('üìñ ========================');
        }

        // „Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó„ÉÜ„Çπ„ÉàÊ©üËÉΩ
        window.testPopup = () => {
            log('üß™ „Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó„ÉÜ„Çπ„ÉàÈñãÂßã...');
            
            try {
                const testWindow = window.open('', '_blank', 'width=400,height=500');
                
                if (testWindow) {
                    log('‚úÖ „Éù„ÉÉ„Éó„Ç¢„ÉÉ„ÉóË®±ÂèØÊ∏à„Åø - „É≠„Ç∞„Ç§„É≥ÂèØËÉΩ„Åß„Åô');
                    testWindow.close();
                    log('üí° „ÄåGoogle„Åß„É≠„Ç∞„Ç§„É≥„Äç„Éú„Çø„É≥„ÇíÊäº„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                } else {
                    log('‚ùå „Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó„Åå„Éñ„É≠„ÉÉ„ÇØ„Åï„Çå„Å¶„ÅÑ„Åæ„Åô');
                    const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
                    showPopupGuide(isMobile);
                }
            } catch (error) {
                log(`‚ùå „Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó„ÉÜ„Çπ„Éà„Ç®„É©„Éº: ${error.message}`);
                const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
                showPopupGuide(isMobile);
            }
        };

        // „É≠„Ç∞„Ç¢„Ç¶„Éà
        window.handleLogout = async () => {
            try {
                await auth.signOut();
                log('üì§ „É≠„Ç∞„Ç¢„Ç¶„ÉàÂÆå‰∫Ü');
            } catch (error) {
                log(`‚ùå „É≠„Ç∞„Ç¢„Ç¶„Éà„Ç®„É©„Éº: ${error.message}`);
            }
        };

        // „Éá„Éº„Çø‰øùÂ≠ò
        window.saveWeightData = async () => {
            if (!currentUser) {
                log('‚ùå „É≠„Ç∞„Ç§„É≥„ÅåÂøÖË¶Å„Åß„Åô');
                return;
            }

            const date = document.getElementById('dateInput').value;
            const value = document.getElementById('weightValue').value;
            const memo = document.getElementById('memoInput').value;

            if (!date || !value) {
                log('‚ùå Êó•‰ªò„Å®ÂÄ§„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }

            try {
                log('üíæ „Éá„Éº„Çø„Çí‰øùÂ≠ò‰∏≠...');
                
                const now = new Date();
                const timeString = now.toLocaleTimeString('ja-JP', { 
                    hour12: false, 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
                
                const weightData = {
                    date: date,
                    time: timeString,
                    value: parseFloat(value),
                    timing: selectedTimingValue || '',
                    memo: memo || '',
                    userEmail: currentUser.email,
                    timestamp: firebase.database.ServerValue.TIMESTAMP,
                    createdAt: now.toISOString()
                };

                const userRef = database.ref(`users/${currentUser.uid}/weights`);
                await userRef.push(weightData);
                log(`‚úÖ ‰øùÂ≠òÂÆå‰∫Ü: ${date} ${timeString} - ${value} ${selectedTimingValue ? `(${selectedTimingValue})` : ''}`);
                
                // ÂÖ•Âäõ„Éï„Ç£„Éº„É´„Éâ„Çí„ÇØ„É™„Ç¢ÔºàÂÄ§„ÅØ50.0„Å´Êàª„ÅôÔºâ
                document.getElementById('weightValue').value = '50.0';
                document.getElementById('memoInput').value = '';
                document.getElementById('selectedTiming').value = '';
                selectedTimingValue = '';
                
                // „Éú„Çø„É≥„ÅÆ„Çπ„Çø„Ç§„É´„Çí„É™„Çª„ÉÉ„Éà
                document.querySelectorAll('.timing-btn').forEach(btn => {
                    btn.style.opacity = '0.7';
                    btn.classList.remove('selected');
                });
                
                // „Éá„Éº„Çø„ÇíÂÜçË™≠„ÅøËæº„Åø
                loadUserWeightData(currentUser.uid);
            } catch (error) {
                log(`‚ùå ‰øùÂ≠ò„Ç®„É©„Éº: ${error.message}`);
            }
        };

        // „Éá„Éº„ÇøÂâäÈô§
        window.deleteWeightEntry = async (entryId) => {
            if (!currentUser) {
                log('‚ùå „É≠„Ç∞„Ç§„É≥„ÅåÂøÖË¶Å„Åß„Åô');
                return;
            }
            
            if (!confirm('„Åì„ÅÆË®òÈå≤„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü')) {
                return;
            }
            
            try {
                log(`üóëÔ∏è „Éá„Éº„ÇøÂâäÈô§‰∏≠: ${entryId}`);
                const entryRef = database.ref(`users/${currentUser.uid}/weights/${entryId}`);
                await entryRef.remove();
                log(`‚úÖ ÂâäÈô§ÂÆå‰∫Ü: ${entryId}`);
            } catch (error) {
                log(`‚ùå ÂâäÈô§„Ç®„É©„Éº: ${error.message}`);
            }
        };

        // „É¶„Éº„Ç∂„Éº„ÅÆ„Éá„Éº„Çø„ÇíË™≠„ÅøËæº„Åø
        function loadUserWeightData(userId) {
            const userRef = database.ref(`users/${userId}/weights`);
            userRef.on('value', (snapshot) => {
                const data = snapshot.val();
                const historyDiv = document.getElementById('weightHistory');
                
                if (data) {
                    const entries = Object.entries(data)
                        .map(([key, value]) => ({ id: key, ...value }))
                        .sort((a, b) => new Date(b.createdAt || b.date) - new Date(a.createdAt || a.date));
                    
                    historyDiv.innerHTML = entries.map(entry => {
                        let displayText = `${entry.date}`;
                        if (entry.time) displayText += ` ${entry.time}`;
                        displayText += `: ${entry.value || entry.weight}`;
                        if (entry.timing) displayText += ` (${entry.timing})`;
                        if (entry.memo) displayText += ` - ${entry.memo}`;
                        return `<div style="display: flex; justify-content: space-between; align-items: center; padding: 2px 0; border-bottom: 1px solid #eee;"><span>${displayText}</span><button onclick="deleteWeightEntry('${entry.id}')" style="background: #dc3545; color: white; border: none; padding: 2px 6px; border-radius: 3px; cursor: pointer; font-size: 10px;">üóëÔ∏è</button></div>`;
                    }).join('');
                    
                    log(`üìà Â±•Ê≠¥Ë™≠„ÅøËæº„ÅøÂÆå‰∫Ü: ${entries.length}‰ª∂`);
                } else {
                    historyDiv.innerHTML = '„Åæ„Å†„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì';
                    log('üìà Â±•Ê≠¥: „Éá„Éº„Çø„Å™„Åó');
                }
            });
        }

        // UIË°®Á§∫Âà∂Âæ°
        function showUserInterface(user) {
            document.getElementById('authSection').classList.add('hidden');
            document.getElementById('userInfo').classList.remove('hidden');
            document.getElementById('userPanel').classList.remove('hidden');
            document.getElementById('userName').textContent = user.displayName;
            
            // „Éö„Ç§„É≥„Éà„Ç≠„É£„É≥„Éê„ÇπÂàùÊúüÂåñ
            setTimeout(() => {
                initPaintCanvas();
            }, 100);
        }

        // ===============================================
        // üé® „Éö„Ç§„É≥„ÉàÊ©üËÉΩÔºàÂü∫Êú¨ÂÆüË£ÖÔºâ
        // ===============================================
        let canvas = null;
        let ctx = null;
        let isDrawing = false;
        let currentTool = 'brush';
        let currentColor = '#ff0080';
        let currentSize = 10;
        let currentOpacity = 1.0;
        let particles = [];
        
        // „Éö„Ç§„É≥„ÉàÊ©üËÉΩÂàùÊúüÂåñ
        function initPaintCanvas() {
            canvas = document.getElementById('paintCanvas');
            if (!canvas) return;
            
            ctx = canvas.getContext('2d');
            
            // „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„ÉºË®≠ÂÆö
            canvas.addEventListener('mousedown', startDrawing);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', stopDrawing);
            canvas.addEventListener('mouseout', stopDrawing);
            
            // „Çø„ÉÉ„ÉÅ„Ç§„Éô„É≥„ÉàÔºà„Çπ„Éû„ÉõÂØæÂøúÔºâ
            canvas.addEventListener('touchstart', handleTouch);
            canvas.addEventListener('touchmove', handleTouch);
            canvas.addEventListener('touchend', stopDrawing);
            
            // „Ç≥„É≥„Éà„É≠„Éº„É´„Ç§„Éô„É≥„Éà
            document.getElementById('brushSize').addEventListener('input', updateBrushSize);
            document.getElementById('colorPicker').addEventListener('input', updateColor);
            document.getElementById('opacity').addEventListener('input', updateOpacity);
            
            // „Éë„Éº„ÉÜ„Ç£„ÇØ„É´„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ÈñãÂßã
            animateParticles();
            
            log('üé® „Éö„Ç§„É≥„Éà„Ç≠„É£„É≥„Éê„ÇπÂàùÊúüÂåñÂÆå‰∫Ü');
        }
        
        // ÊèèÁîªÈñãÂßã
        function startDrawing(e) {
            isDrawing = true;
            const pos = getMousePos(e);
            ctx.beginPath();
            ctx.moveTo(pos.x, pos.y);
            
            // Èü≥ÈüøÂäπÊûú
            playSound('brush');
        }
        
        // ÊèèÁîª‰∏≠
        function draw(e) {
            if (!isDrawing) return;
            
            const pos = getMousePos(e);
            
            switch(currentTool) {
                case 'brush':
                    drawBrush(pos.x, pos.y);
                    break;
                case 'pencil':
                    drawPencil(pos.x, pos.y);
                    break;
                case 'spray':
                    drawSpray(pos.x, pos.y);
                    break;
                case 'glow':
                    drawGlow(pos.x, pos.y);
                    break;
                case 'neon':
                    drawNeon(pos.x, pos.y);
                    break;
                case 'particle':
                    drawParticle(pos.x, pos.y);
                    break;
            }
        }
        
        // ÊèèÁîªÂÅúÊ≠¢
        function stopDrawing() {
            isDrawing = false;
            ctx.beginPath();
        }
        
        // „Éû„Ç¶„ÇπÂ∫ßÊ®ôÂèñÂæó
        function getMousePos(e) {
            const rect = canvas.getBoundingClientRect();
            return {
                x: (e.clientX || e.touches[0].clientX) - rect.left,
                y: (e.clientY || e.touches[0].clientY) - rect.top
            };
        }
        
        // „Çø„ÉÉ„ÉÅ„Ç§„Éô„É≥„ÉàÂá¶ÁêÜ
        function handleTouch(e) {
            e.preventDefault();
            const touch = e.touches[0];
            const mouseEvent = new MouseEvent(e.type === 'touchstart' ? 'mousedown' : 'mousemove', {
                clientX: touch.clientX,
                clientY: touch.clientY
            });
            canvas.dispatchEvent(mouseEvent);
        }
        
        // „ÉÑ„Éº„É´ÈÅ∏Êäû
        window.selectTool = (tool) => {
            currentTool = tool;
            document.querySelectorAll('.tool-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`[data-tool="${tool}"]`).classList.add('active');
            log(`üñåÔ∏è „ÉÑ„Éº„É´ÈÅ∏Êäû: ${tool}`);
        };
        
        // „Éñ„É©„Ç∑„Çµ„Ç§„Ç∫Êõ¥Êñ∞
        function updateBrushSize() {
            currentSize = parseInt(document.getElementById('brushSize').value);
            document.getElementById('brushSizeDisplay').textContent = currentSize;
        }
        
        // „Ç´„É©„ÉºÊõ¥Êñ∞
        function updateColor() {
            currentColor = document.getElementById('colorPicker').value;
        }
        
        // ÈÄèÊòéÂ∫¶Êõ¥Êñ∞
        function updateOpacity() {
            currentOpacity = parseInt(document.getElementById('opacity').value) / 100;
            document.getElementById('opacityDisplay').textContent = Math.round(currentOpacity * 100) + '%';
        }
        
        // Âü∫Êú¨„Éñ„É©„Ç∑ÊèèÁîª
        function drawBrush(x, y) {
            ctx.globalAlpha = currentOpacity;
            ctx.strokeStyle = currentColor;
            ctx.lineWidth = currentSize;
            ctx.lineCap = 'round';
            ctx.lineTo(x, y);
            ctx.stroke();
        }
        
        // „Éö„É≥„Ç∑„É´ÊèèÁîª
        function drawPencil(x, y) {
            ctx.globalAlpha = currentOpacity;
            ctx.strokeStyle = currentColor;
            ctx.lineWidth = Math.max(1, currentSize / 3);
            ctx.lineCap = 'round';
            ctx.lineTo(x, y);
            ctx.stroke();
        }
        
        // „Çπ„Éó„É¨„ÉºÊèèÁîª
        function drawSpray(x, y) {
            ctx.globalAlpha = currentOpacity * 0.6;
            ctx.fillStyle = currentColor;
            
            for (let i = 0; i < currentSize; i++) {
                const offsetX = (Math.random() - 0.5) * currentSize * 2;
                const offsetY = (Math.random() - 0.5) * currentSize * 2;
                ctx.fillRect(x + offsetX, y + offsetY, 1, 1);
            }
        }
        
        // „Ç∞„É≠„ÉºÂäπÊûú
        function drawGlow(x, y) {
            ctx.globalAlpha = currentOpacity;
            ctx.shadowColor = currentColor;
            ctx.shadowBlur = currentSize * 2;
            ctx.strokeStyle = currentColor;
            ctx.lineWidth = currentSize;
            ctx.lineCap = 'round';
            ctx.lineTo(x, y);
            ctx.stroke();
            ctx.shadowBlur = 0;
        }
        
        // „Éç„Ç™„É≥ÂäπÊûú
        function drawNeon(x, y) {
            // Â§ñÂÅ¥„ÅÆ„Ç∞„É≠„Éº
            ctx.globalAlpha = currentOpacity * 0.3;
            ctx.shadowColor = currentColor;
            ctx.shadowBlur = currentSize * 3;
            ctx.strokeStyle = currentColor;
            ctx.lineWidth = currentSize * 2;
            ctx.lineCap = 'round';
            ctx.lineTo(x, y);
            ctx.stroke();
            
            // ÂÜÖÂÅ¥„ÅÆÊòé„Çã„ÅÑÁ∑ö
            ctx.globalAlpha = currentOpacity;
            ctx.shadowBlur = currentSize;
            ctx.strokeStyle = '#ffffff';
            ctx.lineWidth = currentSize / 2;
            ctx.lineTo(x, y);
            ctx.stroke();
            ctx.shadowBlur = 0;
        }
        
        // „Éë„Éº„ÉÜ„Ç£„ÇØ„É´ÂäπÊûú
        function drawParticle(x, y) {
            // „Éë„Éº„ÉÜ„Ç£„ÇØ„É´„ÇíËøΩÂä†
            for (let i = 0; i < 5; i++) {
                particles.push({
                    x: x + (Math.random() - 0.5) * 20,
                    y: y + (Math.random() - 0.5) * 20,
                    vx: (Math.random() - 0.5) * 4,
                    vy: (Math.random() - 0.5) * 4,
                    life: 1.0,
                    color: currentColor,
                    size: Math.random() * currentSize / 2
                });
            }
        }
        
        // „Éë„Éº„ÉÜ„Ç£„ÇØ„É´„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥
        function animateParticles() {
            // „Éë„Éº„ÉÜ„Ç£„ÇØ„É´Êõ¥Êñ∞
            particles.forEach((particle, index) => {
                particle.x += particle.vx;
                particle.y += particle.vy;
                particle.life -= 0.02;
                particle.size *= 0.98;
                
                if (particle.life <= 0) {
                    particles.splice(index, 1);
                } else {
                    ctx.globalAlpha = particle.life * currentOpacity;
                    ctx.fillStyle = particle.color;
                    ctx.fillRect(particle.x, particle.y, particle.size, particle.size);
                }
            });
            
            requestAnimationFrame(animateParticles);
        }
        
        // „Ç≠„É£„É≥„Éê„Çπ„ÇØ„É™„Ç¢
        window.clearCanvas = () => {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            particles = [];
            playSound('clear');
            log('üóëÔ∏è „Ç≠„É£„É≥„Éê„Çπ„Çí„ÇØ„É™„Ç¢„Åó„Åæ„Åó„Åü');
        };
        
        // ‰ΩúÂìÅ‰øùÂ≠òÔºàFirebaseÔºâ
        window.savePainting = async () => {
            if (!currentUser) {
                log('‚ùå „É≠„Ç∞„Ç§„É≥„ÅåÂøÖË¶Å„Åß„Åô');
                return;
            }
            
            const title = document.getElementById('paintingTitle').value || 'ÁÑ°È°å„ÅÆ‰ΩúÂìÅ';
            const imageData = canvas.toDataURL();
            
            try {
                const paintingData = {
                    title: title,
                    canvasData: imageData,
                    date: new Date().toLocaleDateString(),
                    time: new Date().toLocaleTimeString(),
                    userEmail: currentUser.email,
                    timestamp: firebase.database.ServerValue.TIMESTAMP,
                    createdAt: new Date().toISOString()
                };
                
                const userRef = database.ref(`users/${currentUser.uid}/paintings`);
                await userRef.push(paintingData);
                
                playSound('save');
                log(`‚úÖ ‰ΩúÂìÅ‰øùÂ≠òÂÆå‰∫Ü: ${title}`);
                document.getElementById('paintingTitle').value = '';
            } catch (error) {
                log(`‚ùå ‰øùÂ≠ò„Ç®„É©„Éº: ${error.message}`);
            }
        };
        
        // ‰ΩúÂìÅ„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ
        window.downloadPainting = () => {
            const title = document.getElementById('paintingTitle').value || 'awesome-painting';
            const link = document.createElement('a');
            link.download = `${title}.png`;
            link.href = canvas.toDataURL();
            link.click();
            log(`üíæ ‰ΩúÂìÅ„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ: ${title}.png`);
        };
        
        // Èü≥ÈüøÂäπÊûú
        function playSound(type) {
            try {
                // Web Audio API„Çí‰ΩøÁî®„Åó„ÅüÁ∞°Âçò„Å™Èü≥ÁîüÊàê
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                switch(type) {
                    case 'brush':
                        oscillator.frequency.value = 220;
                        gainNode.gain.value = 0.05;
                        break;
                    case 'save':
                        oscillator.frequency.value = 440;
                        gainNode.gain.value = 0.1;
                        break;
                    case 'clear':
                        oscillator.frequency.value = 110;
                        gainNode.gain.value = 0.05;
                        break;
                }
                
                oscillator.start();
                oscillator.stop(audioContext.currentTime + 0.1);
            } catch (e) {
                // Èü≥Èüø„Åå‰Ωø„Åà„Å™„ÅÑÂ†¥Âêà„ÅØÁÑ°Ë¶ñ
            }
        }

        function showLoginInterface() {
            document.getElementById('authSection').classList.remove('hidden');
            document.getElementById('userPanel').classList.add('hidden');
        }

        // „É≠„Ç∞Âá∫ÂäõÈñ¢Êï∞
        function log(message) {
            const logArea = document.getElementById('logArea');
            const timestamp = new Date().toLocaleTimeString();
            logArea.innerHTML += `[${timestamp}] ${message}<br>`;
            logArea.scrollTop = logArea.scrollHeight;
            console.log(message);
        }

        // „É≠„Ç∞„Ç≥„Éî„ÉºÊ©üËÉΩ
        window.copyLogs = () => {
            const logArea = document.getElementById('logArea');
            const logText = logArea.innerText || logArea.textContent;
            navigator.clipboard.writeText(logText).then(() => {
                alert('‚úÖ „É≠„Ç∞„Çí„Ç≥„Éî„Éº„Åó„Åæ„Åó„Åü');
            }).catch(() => {
                // fallback
                const textArea = document.createElement('textarea');
                textArea.value = logText;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                alert('‚úÖ „É≠„Ç∞„Çí„Ç≥„Éî„Éº„Åó„Åæ„Åó„Åü');
            });
        };

        // FirebaseÊé•Á∂ö„Éá„Éê„ÉÉ„Ç∞
        window.debugFirebaseConnection = () => {
            log('üîç === Firebase Debug ÈñãÂßã ===');
            
            // 1. FirebaseË®≠ÂÆöÁ¢∫Ë™ç
            log(`üî• Firebase ConfigÁ¢∫Ë™ç:`);
            log(`- Project ID: ${firebaseConfig.projectId}`);
            log(`- Database URL: ${firebaseConfig.databaseURL}`);
            log(`- Auth Domain: ${firebaseConfig.authDomain}`);
            
            // 2. Ë™çË®ºÁä∂ÊÖãÁ¢∫Ë™ç
            if (currentUser) {
                log(`‚úÖ Ë™çË®ºÊ∏à„Åø„É¶„Éº„Ç∂„Éº:`);
                log(`- UID: ${currentUser.uid.substring(0,8)}...`);
                log(`- Email: ${currentUser.email}`);
                log(`- Ë°®Á§∫Âêç: ${currentUser.displayName}`);
            } else {
                log('‚ùå Êú™Ë™çË®ºÁä∂ÊÖã');
            }
            
            // 3. Êé•Á∂ö„ÉÜ„Çπ„Éà
            const connectedRef = database.ref('.info/connected');
            connectedRef.once('value', (snapshot) => {
                const connected = snapshot.val();
                log(`üåê FirebaseÊé•Á∂öÁä∂ÊÖã: ${connected ? 'Êé•Á∂ö‰∏≠' : 'Êú™Êé•Á∂ö'}`);
                
                if (connected && currentUser) {
                    // „Éá„Éº„Çø„Éô„Éº„Çπ„ÉÜ„Çπ„Éà
                    const testRef = database.ref(`users/${currentUser.uid}/test`);
                    testRef.set({
                        timestamp: firebase.database.ServerValue.TIMESTAMP,
                        message: 'Connection test',
                        app: 'app-template'
                    }).then(() => {
                        log('‚úÖ „Éá„Éº„Çø„Éô„Éº„ÇπÊõ∏„ÅçËæº„Åø„ÉÜ„Çπ„ÉàÊàêÂäü');
                    }).catch((error) => {
                        log(`‚ùå „Éá„Éº„Çø„Éô„Éº„ÇπÊõ∏„ÅçËæº„Åø„Ç®„É©„Éº: ${error.message}`);
                        log(`- Error Code: ${error.code}`);
                    });
                }
            });
            
            log('üîç === Firebase Debug ÂÆå‰∫Ü ===');
        };

        // „É¢„Éê„Ç§„É´Áí∞Â¢ÉË®∫Êñ≠
        window.checkMobileSupport = () => {
            log('üì± === „É¢„Éê„Ç§„É´Áí∞Â¢ÉË®∫Êñ≠ ÈñãÂßã ===');
            
            const userAgent = navigator.userAgent;
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(userAgent);
            
            log(`üåê „É¶„Éº„Ç∂„Éº„Ç®„Éº„Ç∏„Çß„É≥„Éà: ${userAgent}`);
            log(`üì± „É¢„Éê„Ç§„É´„Éá„Éê„Ç§„ÇπÂà§ÂÆö: ${isMobile ? '„É¢„Éê„Ç§„É´' : '„Éá„Çπ„ÇØ„Éà„ÉÉ„Éó'}`);
            
            // „Éñ„É©„Ç¶„Ç∂Âà§ÂÆö
            const isChrome = /Chrome/i.test(userAgent);
            const isSafari = /Safari/i.test(userAgent) && !/Chrome/i.test(userAgent);
            const isFirefox = /Firefox/i.test(userAgent);
            
            log(`üåê „Éñ„É©„Ç¶„Ç∂: ${isChrome ? 'Chrome' : isSafari ? 'Safari' : isFirefox ? 'Firefox' : '‰∏çÊòé'}`);
            
            // „É≠„Ç∞„Ç§„É≥ÊñπÂºè„ÅÆÊé®Â•®
            if (isMobile) {
                log('üí° „É¢„Éê„Ç§„É´„ÅÆÊé®Â•®Ë®≠ÂÆö:');
                log('- Google„É≠„Ç∞„Ç§„É≥„ÅØ„É™„ÉÄ„Ç§„É¨„ÇØ„ÉàÊñπÂºè„Çí‰ΩøÁî®');
                log('- „Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó„Éñ„É≠„ÉÉ„Ç´„Éº„ÅÆÂΩ±Èüø„Å™„Åó');
                log('- Ë™çË®ºÂæå„Å´„Éö„Éº„Ç∏„ÅåÂÜçË™≠„ÅøËæº„Åø„Åï„Çå„Åæ„Åô');
            }
            
            log('üì± === „É¢„Éê„Ç§„É´Áí∞Â¢ÉË®∫Êñ≠ ÂÆå‰∫Ü ===');
        };

        // FirebaseË®≠ÂÆöË®∫Êñ≠
        window.checkFirebaseConfig = () => {
            log('üîß === FirebaseË®≠ÂÆöË®∫Êñ≠ ÈñãÂßã ===');
            
            // ÁèæÂú®„ÅÆ„Éâ„É°„Ç§„É≥Á¢∫Ë™ç
            const currentDomain = window.location.hostname;
            const currentUrl = window.location.href;
            log(`üåê ÁèæÂú®„ÅÆ„Éâ„É°„Ç§„É≥: ${currentDomain}`);
            log(`üîó ÁèæÂú®„ÅÆURL: ${currentUrl}`);
            
            // FirebaseË®≠ÂÆöÊÉÖÂ†±
            log(`üî• FirebaseË®≠ÂÆö:`);
            log(`- Project ID: ${firebaseConfig.projectId}`);
            log(`- Auth Domain: ${firebaseConfig.authDomain}`);
            log(`- Database URL: ${firebaseConfig.databaseURL}`);
            
            // Ë™çË®º„Éâ„É°„Ç§„É≥Ë®±ÂèØÁä∂Ê≥Å„ÅÆÊé®Ê∏¨
            if (currentDomain === 'muumuu8181.github.io') {
                log('‚úÖ GitHub Pages„Éâ„É°„Ç§„É≥Ê§úÂá∫');
                log('üí° Firebase Console„Åß„Åì„ÅÆ„Éâ„É°„Ç§„É≥„ÅåË®±ÂèØ„Åï„Çå„Å¶„ÅÑ„Çã„ÅãÁ¢∫Ë™ç„ÅåÂøÖË¶Å');
            } else if (currentDomain === 'localhost' || currentDomain === '127.0.0.1') {
                log('‚úÖ „É≠„Éº„Ç´„É´„Éõ„Çπ„ÉàÊ§úÂá∫');
                log('üí° ÈÄöÂ∏∏„ÅØËá™Âãï„ÅßË®±ÂèØ„Åï„Çå„Å¶„ÅÑ„Åæ„Åô');
            } else {
                log('‚ö†Ô∏è ‰∏çÊòé„Å™„Éâ„É°„Ç§„É≥„Åß„Åô');
                log('üí° Firebase Console„ÅÆË™çË®ºË®≠ÂÆö„ÅßË®±ÂèØ„ÅåÂøÖË¶Å„Åã„ÇÇ„Åó„Çå„Åæ„Åõ„Çì');
            }
            
            // „É¢„Éê„Ç§„É´„Éñ„É©„Ç¶„Ç∂„Åß„ÅÆ„É™„ÉÄ„Ç§„É¨„ÇØ„ÉàÂà∂ÈôêÁ¢∫Ë™ç
            const userAgent = navigator.userAgent;
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(userAgent);
            
            if (isMobile) {
                log('üì± „É¢„Éê„Ç§„É´„Éñ„É©„Ç¶„Ç∂Âõ∫Êúâ„ÅÆÂà∂Èôê:');
                log('- Safari: „Çµ„Éº„Éâ„Éë„Éº„ÉÜ„Ç£Cookie„ÅÆÂà∂Èôê„ÅÇ„Çä');
                log('- Chrome Mobile: „Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó„ÅÆËá™Âãï„Éñ„É≠„ÉÉ„ÇØ');
                log('- Ëß£Ê±∫Á≠ñ: „É™„ÉÄ„Ç§„É¨„ÇØ„ÉàÊñπÂºè„Åæ„Åü„ÅØ„Éù„ÉÉ„Éó„Ç¢„ÉÉ„ÉóË®±ÂèØË®≠ÂÆö');
            }
            
            log('üîß === FirebaseË®≠ÂÆöË®∫Êñ≠ ÂÆå‰∫Ü ===');
        };

        // Ë™çË®ºÁä∂ÊÖã„ÅÆÂº∑Âà∂Á¢∫Ë™ç
        window.forceAuthCheck = () => {
            log('üîç === Ë™çË®ºÁä∂ÊÖãÂº∑Âà∂Á¢∫Ë™ç ÈñãÂßã ===');
            
            const user = auth.currentUser;
            log(`üîê FirebaseË™çË®ºÁä∂ÊÖã: ${user ? `„É≠„Ç∞„Ç§„É≥Ê∏à„Åø (${user.displayName})` : 'Êú™„É≠„Ç∞„Ç§„É≥'}`);
            
            if (user) {
                log('‚úÖ „É¶„Éº„Ç∂„ÉºÁîªÈù¢„ÇíË°®Á§∫„Åó„Åæ„Åô');
                showUserInterface(user);
                loadUserWeightData(user.uid);
            } else {
                log('‚ùå „É≠„Ç∞„Ç§„É≥ÁîªÈù¢„ÇíË°®Á§∫„Åó„Åæ„Åô');
                showLoginInterface();
            }
            
            // Ë™çË®º„Éà„Éº„ÇØ„É≥„ÅÆÊúâÂäπÊÄßÁ¢∫Ë™ç
            if (user) {
                user.getIdToken(true).then(() => {
                    log('‚úÖ Ë™çË®º„Éà„Éº„ÇØ„É≥„ÅØÊúâÂäπ„Åß„Åô');
                }).catch((tokenError) => {
                    log(`‚ùå Ë™çË®º„Éà„Éº„ÇØ„É≥„Ç®„É©„Éº: ${tokenError.message}`);
                    log('üí° ÂÜç„É≠„Ç∞„Ç§„É≥„ÅåÂøÖË¶Å„Åã„ÇÇ„Åó„Çå„Åæ„Åõ„Çì');
                });
            }
            
            log('üîç === Ë™çË®ºÁä∂ÊÖãÂº∑Âà∂Á¢∫Ë™ç ÂÆå‰∫Ü ===');
        };

        // „É≠„Ç∞„Ç§„É≥ÂïèÈ°åË®∫Êñ≠
        window.checkLoginIssues = () => {
            log('‚ö†Ô∏è === „É≠„Ç∞„Ç§„É≥ÂïèÈ°åË®∫Êñ≠ ÈñãÂßã ===');
            
            // 1. „Éó„É≠„Éà„Ç≥„É´„ÉÅ„Çß„ÉÉ„ÇØ
            const protocol = window.location.protocol;
            log(`üåê ÁèæÂú®„ÅÆ„Éó„É≠„Éà„Ç≥„É´: ${protocol}`);
            
            if (protocol === 'file:') {
                log('‚ùå ÂïèÈ°åÁô∫Ë¶ã: file://„Éó„É≠„Éà„Ç≥„É´„Åß„ÅØGoogleË™çË®º„ÅåÂãï‰Ωú„Åó„Åæ„Åõ„Çì');
                log('‚úÖ Ëß£Ê±∫ÊñπÊ≥ï:');
                log('  1. HTTP„Çµ„Éº„Éê„ÉºÁµåÁî±„Åß„Ç¢„ÇØ„Çª„Çπ');
                log('  2. chrome://flags „Åß insecure origins „ÇíË®±ÂèØ');
                log('  3. „É≠„Éº„Ç´„É´„Çµ„Éº„Éê„ÉºËµ∑Âãï (python -m http.server 8000)');
            } else if (protocol === 'https:' || protocol === 'http:') {
                log('‚úÖ „Éó„É≠„Éà„Ç≥„É´: ÂïèÈ°å„Å™„Åó');
            }
            
            // 2. Web StorageÁ¢∫Ë™ç
            try {
                localStorage.setItem('test', 'test');
                localStorage.removeItem('test');
                log('‚úÖ Web Storage: Âà©Áî®ÂèØËÉΩ');
            } catch (e) {
                log('‚ùå Web Storage: ÁÑ°Âäπ');
                log('‚úÖ Ëß£Ê±∫ÊñπÊ≥ï: „Éñ„É©„Ç¶„Ç∂Ë®≠ÂÆö„ÅßCookie„ÇíÊúâÂäπ„Å´„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
            }
            
            // 3. Firebase„É©„Ç§„Éñ„É©„É™Á¢∫Ë™ç
            if (typeof firebase !== 'undefined') {
                log('‚úÖ Firebase SDK: Ë™≠„ÅøËæº„ÅøÊ∏à„Åø');
                log(`- Firebase Version: ${firebase.SDK_VERSION || 'Unknown'}`);
            } else {
                log('‚ùå Firebase SDK: Ë™≠„ÅøËæº„Åø„Ç®„É©„Éº');
            }
            
            // 4. „Éâ„É°„Ç§„É≥Á¢∫Ë™ç
            const domain = window.location.hostname;
            log(`üè† ÁèæÂú®„ÅÆ„Éâ„É°„Ç§„É≥: ${domain}`);
            
            if (domain === 'localhost' || domain === '127.0.0.1') {
                log('‚úÖ „É≠„Éº„Ç´„É´ÈñãÁô∫: FirebaseË®≠ÂÆö„ÅßË®±ÂèØ„ÅåÂøÖË¶Å');
            }
            
            log('‚ö†Ô∏è === „É≠„Ç∞„Ç§„É≥ÂïèÈ°åË®∫Êñ≠ ÂÆå‰∫Ü ===');
        };

        // „Éá„Éº„Çø„Éô„Éº„ÇπÊßãÈÄ†Á¢∫Ë™ç
        window.checkDatabaseStructure = async () => {
            if (!currentUser) {
                log('‚ùå „É≠„Ç∞„Ç§„É≥„ÅåÂøÖË¶Å„Åß„Åô');
                return;
            }
            
            log('üèóÔ∏è === „Éá„Éº„Çø„Éô„Éº„ÇπÊßãÈÄ†Á¢∫Ë™ç ÈñãÂßã ===');
            
            try {
                // ÁèæÂú®„ÅÆ„É¶„Éº„Ç∂„Éº„ÅÆweights„Éá„Éº„ÇøÊßãÈÄ†„ÇíÁ¢∫Ë™ç
                const userRef = database.ref(`users/${currentUser.uid}/weights`);
                const snapshot = await userRef.once('value');
                const data = snapshot.val();
                
                if (data) {
                    const entries = Object.keys(data);
                    log(`üìä ÁèæÂú®„ÅÆ„É¶„Éº„Ç∂„Éº(${currentUser.email})„ÅÆ„Éá„Éº„Çø:`);
                    log(`- Ë®òÈå≤Êï∞: ${entries.length}‰ª∂`);
                    log(`- ÊúÄÊñ∞Ë®òÈå≤ID: ${entries[entries.length - 1]}`);
                    
                    // „Çµ„É≥„Éó„É´„Éá„Éº„ÇøÊßãÈÄ†„ÇíË°®Á§∫
                    const sampleEntry = data[entries[0]];
                    log(`- „Éá„Éº„ÇøÊßãÈÄ†: ${JSON.stringify(sampleEntry, null, 2)}`);
                } else {
                    log('üìä ÁèæÂú®„ÅÆ„É¶„Éº„Ç∂„Éº„Å´„ÅØ„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì');
                }
                
                // „É´„Éº„Éà„É¨„Éô„É´„ÅÆÊßãÈÄ†Á¢∫Ë™çÔºàÁÆ°ÁêÜËÄÖÊ®©Èôê„ÅåÂøÖË¶ÅÔºâ
                try {
                    const rootRef = database.ref('users');
                    const rootSnapshot = await rootRef.once('value');
                    const allUsers = rootSnapshot.val();
                    
                    if (allUsers) {
                        const userCount = Object.keys(allUsers).length;
                        log(`üë• ÂÖ®‰ΩìÁµ±Ë®à:`);
                        log(`- ÁôªÈå≤„É¶„Éº„Ç∂„ÉºÊï∞: ${userCount}‰∫∫`);
                        
                        let totalWeights = 0;
                        Object.values(allUsers).forEach(user => {
                            if (user.weights) {
                                totalWeights += Object.keys(user.weights).length;
                            }
                        });
                        log(`- ÂÖ®‰Ωì„ÅÆË®òÈå≤Êï∞: ${totalWeights}‰ª∂`);
                    }
                } catch (error) {
                    log(`‚ö†Ô∏è ÂÖ®‰ΩìÁµ±Ë®à„ÅÆÂèñÂæó„Å´Âà∂Èôê„Åå„ÅÇ„Çä„Åæ„Åô: ${error.message}`);
                }
                
            } catch (error) {
                log(`‚ùå ÊßãÈÄ†Á¢∫Ë™ç„Ç®„É©„Éº: ${error.message}`);
            }
            
            log('üèóÔ∏è === „Éá„Éº„Çø„Éô„Éº„ÇπÊßãÈÄ†Á¢∫Ë™ç ÂÆå‰∫Ü ===');
        };

        // „Éá„Éê„ÉÉ„Ç∞ÊÉÖÂ†±„Çí„Ç≥„Éî„Éº
        window.copyDebugInfo = () => {
            const debugInfo = `„Ç¢„Éó„É™„ÉÜ„É≥„Éó„É¨„Éº„Éà v0.24 „Éá„Éê„ÉÉ„Ç∞ÊÉÖÂ†±
=================================
„Çø„Ç§„É†„Çπ„Çø„É≥„Éó: ${new Date().toLocaleString()}
URL: ${window.location.href}
„Éó„É≠„Éà„Ç≥„É´: ${window.location.protocol}
„Éâ„É°„Ç§„É≥: ${window.location.hostname}
„É¶„Éº„Ç∂„Éº„Ç®„Éº„Ç∏„Çß„É≥„Éà: ${navigator.userAgent}

FirebaseË®≠ÂÆö:
- „Éó„É≠„Ç∏„Çß„ÇØ„ÉàID: ${firebaseConfig.projectId}
- „Éá„Éº„Çø„Éô„Éº„ÇπURL: ${firebaseConfig.databaseURL}
- Ë™çË®º„Éâ„É°„Ç§„É≥: ${firebaseConfig.authDomain}

Ë™çË®ºÁä∂ÊÖã: ${currentUser ? '„É≠„Ç∞„Ç§„É≥Ê∏à„Åø' : 'Êú™„É≠„Ç∞„Ç§„É≥'}
${currentUser ? `- UID: ${currentUser.uid.substring(0,8)}...\n- Email: ${currentUser.email}\n- Ë°®Á§∫Âêç: ${currentUser.displayName}` : ''}

Firebase SDK: ${typeof firebase !== 'undefined' ? 'Ë™≠„ÅøËæº„ÅøÊ∏à„Åø' : 'Ë™≠„ÅøËæº„Åø„Ç®„É©„Éº'}
Web Storage: ${(() => {
    try {
        localStorage.setItem('test', 'test');
        localStorage.removeItem('test');
        return 'Âà©Áî®ÂèØËÉΩ';
    } catch (e) {
        return 'ÁÑ°Âäπ';
    }
})()}

„É≠„Ç∞ÂÜÖÂÆπ:
${document.getElementById('logArea').innerText}`;

            navigator.clipboard.writeText(debugInfo).then(() => {
                alert('‚úÖ „Éá„Éê„ÉÉ„Ç∞ÊÉÖÂ†±„Çí„Ç≥„Éî„Éº„Åó„Åæ„Åó„Åü');
            }).catch(() => {
                // fallback
                const textArea = document.createElement('textarea');
                textArea.value = debugInfo;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                alert('‚úÖ „Éá„Éê„ÉÉ„Ç∞ÊÉÖÂ†±„Çí„Ç≥„Éî„Éº„Åó„Åæ„Åó„Åü');
            });
        };

        // ÂàùÊúüÂåñ
        // „Éë„Éç„É´„É¢„Éº„ÉâÂàá„ÇäÊõø„Åà
        window.togglePanelMode = () => {
            document.body.classList.toggle('panel-mode');
            const btn = document.querySelector('.mode-toggle');
            if (document.body.classList.contains('panel-mode')) {
                btn.textContent = 'üìä „Éë„Éç„É´Ë°®Á§∫';
                log('üìä „Éë„Éç„É´Ë°®Á§∫„É¢„Éº„Éâ: ON');
            } else {
                btn.textContent = 'üìÑ ÈÄöÂ∏∏Ë°®Á§∫';
                log('üìÑ „Éë„Éç„É´Ë°®Á§∫„É¢„Éº„Éâ: OFF');
            }
        };
        
        // „Ç∞„É™„ÉÉ„Éâ„É¢„Éº„ÉâÂàá„ÇäÊõø„Åà
        window.toggleGridMode = () => {
            const hasGridMode = document.body.classList.contains('grid-mode');
            log(`ÁèæÂú®„ÅÆ„Ç∞„É™„ÉÉ„Éâ„É¢„Éº„Éâ: ${hasGridMode ? 'ON' : 'OFF'}`);
            
            document.body.classList.toggle('grid-mode');
            const btn = document.querySelector('.grid-toggle');
            
            if (document.body.classList.contains('grid-mode')) {
                btn.textContent = '‚ñ° „Ç∞„É™„ÉÉ„ÉâOFF';
                btn.style.background = '#dc3545';
                log('‚äû „Ç∞„É™„ÉÉ„ÉâË°®Á§∫„É¢„Éº„Éâ: ON „Å´Âàá„ÇäÊõø„Åà');
                createGridOverlay();
            } else {
                btn.textContent = '‚äû „Ç∞„É™„ÉÉ„ÉâË°®Á§∫';
                btn.style.background = '#28a745';
                log('‚ñ° „Ç∞„É™„ÉÉ„ÉâË°®Á§∫„É¢„Éº„Éâ: OFF „Å´Âàá„ÇäÊõø„Åà');
                removeGridOverlay();
            }
        };
        
        // „Ç∞„É™„ÉÉ„Éâ„Ç™„Éº„Éê„Éº„É¨„Ç§‰ΩúÊàêÔºà„Ç∑„É≥„Éó„É´ÁâàÔºâ
        function createGridOverlay() {
            // Êó¢Â≠ò„ÅÆ„Ç™„Éº„Éê„Éº„É¨„Ç§„ÇíÂâäÈô§
            removeGridOverlay();
            
            const overlay = document.createElement('div');
            overlay.className = 'grid-overlay';
            overlay.id = 'gridOverlay';
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                pointer-events: none !important;
                z-index: 10000000;
            `;
            
            // „Ç∞„É™„ÉÉ„ÉâË®≠ÂÆö
            const gridSize = 30; // „Éî„ÇØ„Çª„É´Âçò‰Ωç
            const maxCols = Math.ceil(window.innerWidth / gridSize);
            const maxRows = Math.min(100, Math.ceil(window.innerHeight / gridSize)); // ÊúÄÂ§ß100Ë°å
            
            // ExcelÈ¢®„ÅÆÂàó„É©„Éô„É´ÁîüÊàêÈñ¢Êï∞
            function getColumnLabel(index) {
                let label = '';
                let num = index;
                while (num >= 0) {
                    label = String.fromCharCode(65 + (num % 26)) + label;
                    num = Math.floor(num / 26) - 1;
                    if (num < 0) break;
                }
                return label;
            }
            
            // „Ç∞„É™„ÉÉ„ÉâÁ∑ö„ÇíËøΩÂä†
            for (let i = 0; i <= maxCols; i++) {
                // ÂûÇÁõ¥Á∑ö
                const vLine = document.createElement('div');
                vLine.style.cssText = `
                    position: absolute;
                    left: ${i * gridSize}px;
                    top: 0;
                    width: 1px;
                    height: 100%;
                    background: rgba(40,167,69,0.2);
                    pointer-events: none;
                    z-index: 999998;
                `;
                overlay.appendChild(vLine);
            }
            
            for (let i = 0; i <= maxRows; i++) {
                // Ê∞¥Âπ≥Á∑ö
                const hLine = document.createElement('div');
                hLine.style.cssText = `
                    position: absolute;
                    left: 0;
                    top: ${i * gridSize}px;
                    width: 100%;
                    height: 1px;
                    background: rgba(40,167,69,0.2);
                    pointer-events: none;
                    z-index: 999998;
                `;
                overlay.appendChild(hLine);
            }
            
            // „É©„Éô„É´„ÇíËøΩÂä†Ôºà„Åô„Åπ„Å¶„ÅÆ„Ç∞„É™„ÉÉ„Éâ„Å´Ë°®Á§∫Ôºâ
            for (let row = 0; row <= maxRows; row++) {
                for (let col = 0; col <= maxCols; col++) {
                    if (row === 0 || col === 0) {
                        const label = document.createElement('div');
                        label.className = 'grid-number';
                        label.style.cssText = `
                            position: absolute;
                            font-size: 10px;
                            color: rgba(40,167,69,0.9);
                            font-weight: bold;
                            background: rgba(255,255,255,0.95);
                            padding: 1px 3px;
                            border-radius: 2px;
                            pointer-events: none;
                            z-index: 999999;
                        `;
                        
                        if (row === 0 && col > 0) {
                            // ‰∏äÈÉ®„Å´Âàó„É©„Éô„É´ÔºàA,B,C...Z,AA,AB...Ôºâ
                            label.textContent = getColumnLabel(col - 1);
                            label.style.left = `${col * gridSize - 10}px`;
                            label.style.top = '2px';
                            overlay.appendChild(label);
                        } else if (col === 0 && row > 0) {
                            // Â∑¶ÂÅ¥„Å´Ë°åÁï™Âè∑Ôºà1,2,3...100Ôºâ
                            label.textContent = row.toString();
                            label.style.left = '2px';
                            label.style.top = `${row * gridSize - 10}px`;
                            overlay.appendChild(label);
                        }
                    }
                }
            }
            
            document.body.appendChild(overlay);
        }
        
        function removeGridOverlay() {
            const overlay = document.getElementById('gridOverlay');
            if (overlay) overlay.remove();
        }
        
        // „Ç∞„É™„ÉÉ„Éâ‰ΩçÁΩÆË™øÊï¥„Éò„É´„Éë„ÉºÈñ¢Êï∞
        window.adjustGridPosition = (selector, gridCode, adjustment) => {
            // gridCode‰æã: "B4-C" (ÂàóB, Ë°å4-CÁØÑÂõ≤)
            // adjustment‰æã: 0.5 (0.5„Ç∞„É™„ÉÉ„ÉâÂàÜÁü≠„Åè/Â∞è„Åï„Åè)
            const element = document.querySelector(selector);
            if (!element) {
                log(`‚ùå Ë¶ÅÁ¥†„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì: ${selector}`);
                return;
            }
            
            // „Ç∞„É™„ÉÉ„Éâ„Ç≥„Éº„Éâ„ÅÆËß£Êûê (‰æã: "B4" ‚Üí ÂàóB(2), Ë°å4)
            const match = gridCode.match(/^([A-T])(\d+)(?:-([A-T])?(\d+)?)?$/);
            if (!match) {
                log(`‚ùå ÁÑ°Âäπ„Å™„Ç∞„É™„ÉÉ„Éâ„Ç≥„Éº„Éâ: ${gridCode}`);
                return;
            }
            
            const startCol = match[1].charCodeAt(0) - 'A'.charCodeAt(0) + 1;
            const startRow = parseInt(match[2]);
            const endCol = match[3] ? match[3].charCodeAt(0) - 'A'.charCodeAt(0) + 1 : startCol;
            const endRow = match[4] ? parseInt(match[4]) : startRow;
            
            // „Ç∞„É™„ÉÉ„ÉâÂçò‰Ωç„Çí„Éî„ÇØ„Çª„É´„Å´Â§âÊèõÔºà30px„Åå1„Ç∞„É™„ÉÉ„ÉâÔºâ
            const gridWidth = 30;
            const gridHeight = 30;
            
            // ÁèæÂú®„ÅÆ„Çπ„Çø„Ç§„É´„ÇíÂèñÂæó
            const currentStyle = window.getComputedStyle(element);
            const currentWidth = parseFloat(currentStyle.width);
            const currentHeight = parseFloat(currentStyle.height);
            
            // Ë™øÊï¥„ÇíÈÅ©Áî®
            if (adjustment < 0) {
                // „Éû„Ç§„Éä„ÇπË™øÊï¥ = Áü≠„Åè/Â∞è„Åï„Åè
                element.style.width = `${currentWidth + (adjustment * gridWidth)}px`;
                element.style.height = `${currentHeight + (adjustment * gridHeight)}px`;
            } else {
                // „Éó„É©„ÇπË™øÊï¥ = Èï∑„Åè/Â§ß„Åç„Åè
                element.style.width = `${currentWidth + (adjustment * gridWidth)}px`;
                element.style.height = `${currentHeight + (adjustment * gridHeight)}px`;
            }
            
            log(`‚úÖ „Ç∞„É™„ÉÉ„ÉâË™øÊï¥ÂÆå‰∫Ü: ${selector} @ ${gridCode} (${adjustment > 0 ? '+' : ''}${adjustment}„Ç∞„É™„ÉÉ„Éâ)`);
        };
        
        // „Ç∞„É™„ÉÉ„Éâ‰ΩçÁΩÆÂèñÂæó„Éò„É´„Éë„ÉºÈñ¢Êï∞
        window.getGridPosition = (selector) => {
            const element = document.querySelector(selector);
            if (!element) {
                log(`‚ùå Ë¶ÅÁ¥†„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì: ${selector}`);
                return null;
            }
            
            const rect = element.getBoundingClientRect();
            const gridCol = Math.floor(rect.left / 30);
            const gridRow = Math.floor(rect.top / 30);
            
            const colLetter = String.fromCharCode('A'.charCodeAt(0) + gridCol);
            const position = `${colLetter}${gridRow + 1}`;
            
            log(`üìç „Ç∞„É™„ÉÉ„Éâ‰ΩçÁΩÆ: ${selector} ‚Üí ${position}`);
            return position;
        };
        
        // „Ç∞„É™„ÉÉ„ÉâË™øÊï¥„ÉÜ„Çπ„ÉàÈñ¢Êï∞
        window.testGridAdjust = () => {
            log('üìê === „Ç∞„É™„ÉÉ„ÉâË™øÊï¥„ÉÜ„Çπ„ÉàÈñãÂßã ===');
            
            // „Éë„Éç„É´„É¨„Éô„É´„ÅÆË¶ÅÁ¥†„ÇíË¶ã„Å§„Åë„Å¶Ë™øÊï¥
            const testElement = document.querySelector('[data-grid="B3"]');
            if (testElement) {
                log('üéØ B3„Éë„Éç„É´Ë¶ÅÁ¥†„ÇíÁô∫Ë¶ã');
                
                // ÂÖÉ„ÅÆ„Çµ„Ç§„Ç∫„ÇíË®òÈå≤
                const originalWidth = testElement.offsetWidth;
                const originalHeight = testElement.offsetHeight;
                log(`üìè ÂÖÉ„ÅÆ„Çµ„Ç§„Ç∫: ${originalWidth}x${originalHeight}px`);
                
                // 0.5„Ç∞„É™„ÉÉ„ÉâÂàÜË™øÊï¥
                adjustGridPosition('[data-grid="B3"]', 'B3', -0.5);
                
                // Êñ∞„Åó„ÅÑ„Çµ„Ç§„Ç∫„ÇíÁ¢∫Ë™ç
                const newWidth = testElement.offsetWidth;
                const newHeight = testElement.offsetHeight;
                log(`üìè Êñ∞„Åó„ÅÑ„Çµ„Ç§„Ç∫: ${newWidth}x${newHeight}px`);
                log(`üìä Â§âÂåñÈáè: ÂπÖ${newWidth - originalWidth}px, È´ò„Åï${newHeight - originalHeight}px`);
                
                // 3ÁßíÂæå„Å´ÂÖÉ„Å´Êàª„Åô
                setTimeout(() => {
                    adjustGridPosition('[data-grid="B3"]', 'B3', 0.5);
                    log('üîÑ ÂÖÉ„ÅÆ„Çµ„Ç§„Ç∫„Å´Âæ©ÂÖÉ„Åó„Åæ„Åó„Åü');
                }, 3000);
                
                log('‚è±Ô∏è 3ÁßíÂæå„Å´Ëá™ÂãïÁöÑ„Å´ÂÖÉ„ÅÆ„Çµ„Ç§„Ç∫„Å´Êàª„Çä„Åæ„Åô');
            } else {
                log('‚ùå B3„Éë„Éç„É´Ë¶ÅÁ¥†„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì');
                log('üí° „Ç∞„É™„ÉÉ„ÉâË°®Á§∫„ÇíON„Å´„Åó„Å¶„ÄÅË¶ÅÁ¥†„ÅÆ‰ΩçÁΩÆ„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
            }
            
            log('üìê === „ÉÜ„Çπ„ÉàÁµÇ‰∫Ü ===');
        };
        
        // ÈõªÂçìÊ©üËÉΩ
        window.appendToDisplay = (value) => {
            const display = document.getElementById('display');
            if (display.value === '0' && value !== '.') {
                display.value = value;
            } else {
                display.value += value;
            }
            log(`üßÆ ÂÖ•Âäõ: ${value}, ÁèæÂú®„ÅÆÂºè: ${display.value}`);
        };

        window.clearDisplay = () => {
            document.getElementById('display').value = '';
            log('üßÆ Ë°®Á§∫„Çí„ÇØ„É™„Ç¢„Åó„Åæ„Åó„Åü');
        };

        window.deleteLast = () => {
            const display = document.getElementById('display');
            display.value = display.value.slice(0, -1);
            log(`üßÆ ÊúÄÂæå„ÅÆÊñáÂ≠ó„ÇíÂâäÈô§: ${display.value}`);
        };

        window.calculate = () => {
            const display = document.getElementById('display');
            const expression = display.value;
            
            try {
                // „Çª„Ç≠„É•„É™„ÉÜ„Ç£„ÅÆ„Åü„ÇÅ„ÄÅÊï∞Â≠ó„Å®Âü∫Êú¨ÊºîÁÆóÂ≠ê„ÅÆ„ÅøË®±ÂèØ
                if (!/^[0-9+\-*/.() ]+$/.test(expression)) {
                    throw new Error('‰∏çÊ≠£„Å™ÊñáÂ≠ó„ÅåÂê´„Åæ„Çå„Å¶„ÅÑ„Åæ„Åô');
                }
                
                // eval„ÅÆ‰ª£„Çè„Çä„Å´Function constructor„Çí‰ΩøÁî®Ôºà„Çà„ÇäÂÆâÂÖ®Ôºâ
                const result = new Function('return ' + expression.replace(/√ó/g, '*').replace(/√∑/g, '/'))();
                
                if (!isFinite(result)) {
                    throw new Error('Ë®àÁÆóÁµêÊûú„ÅåÁÑ°Âäπ„Åß„Åô');
                }
                
                display.value = result.toString();
                log(`üßÆ Ë®àÁÆóÂÆå‰∫Ü: ${expression} = ${result}`);
            } catch (error) {
                display.value = '„Ç®„É©„Éº';
                log(`‚ùå Ë®àÁÆó„Ç®„É©„Éº: ${error.message}`);
            }
        };

        window.saveCalculation = async () => {
            if (!currentUser) {
                log('‚ùå „É≠„Ç∞„Ç§„É≥„ÅåÂøÖË¶Å„Åß„Åô');
                return;
            }
            
            const display = document.getElementById('display');
            const note = document.getElementById('calculationNote');
            
            if (!display.value || display.value === '„Ç®„É©„Éº') {
                log('‚ùå ‰øùÂ≠ò„Åô„ÇãË®àÁÆóÁµêÊûú„Åå„ÅÇ„Çä„Åæ„Åõ„Çì');
                return;
            }
            
            try {
                const calculationData = {
                    result: display.value,
                    note: note.value || '',
                    timestamp: Date.now(),
                    createdAt: new Date().toISOString(),
                    date: new Date().toLocaleDateString('ja-JP'),
                    time: new Date().toLocaleTimeString('ja-JP')
                };
                
                log('üßÆ Ë®àÁÆóÁµêÊûú„Çí‰øùÂ≠ò‰∏≠...');
                const calculationsRef = database.ref(`users/${currentUser.uid}/calculations`);
                const newRef = calculationsRef.push();
                await newRef.set(calculationData);
                
                log(`‚úÖ Ë®àÁÆóÁµêÊûú„Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü: ${display.value}`);
                note.value = '';
            } catch (error) {
                log(`‚ùå ‰øùÂ≠ò„Ç®„É©„Éº: ${error.message}`);
            }
        };

        log('üöÄ ÈõªÂçì„Ç¢„Éó„É™ v0.1 Ëµ∑ÂãïÂÆå‰∫Ü');
        log('üîê Ë™çË®º„Ç∑„Çπ„ÉÜ„É†Ê∫ñÂÇôÂÆå‰∫Ü');
        
        // „Éó„É≠„Éà„Ç≥„É´„ÉÅ„Çß„ÉÉ„ÇØÔºàËá™ÂãïË®∫Êñ≠Ôºâ
        if (window.location.protocol === 'file:') {
            log('‚ö†Ô∏è file://„Éó„É≠„Éà„Ç≥„É´Ê§úÂá∫ - Google„É≠„Ç∞„Ç§„É≥„Å´„ÅØ HTTP„Çµ„Éº„Éê„Éº„ÅåÂøÖË¶Å„Åß„Åô');
            log('üí° Ëß£Ê±∫ÊñπÊ≥ï: python -m http.server 8000 „Åæ„Åü„ÅØ chrome://flagsË®≠ÂÆö');
        }
    </script>
</body>
</html>
